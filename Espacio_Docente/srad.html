<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SRAD - Sistema de Registro y Almacenamiento de Datos</title>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  margin: 0;
  background-color: #f9f9f9;
}
.container {
  border: 2px solid #ccc;
  border-radius: 10px;
  padding: 20px;
  width: 95%;
  max-width: 1000px;
  margin-top: 20px;
  background: white;
  box-sizing: border-box;
  display: none; /* <-- ocultamos todo al cargar la página */
  flex-direction: column;
}
h2 {
  text-align: center;
  margin: 0;
  font-size: 20px;
}
.subtitulo {
  margin: 0;
  text-align: center;
  font-weight: normal;
  margin-bottom: 10px;
}
.filters {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 10px;
  gap: 20px;
  flex-wrap: wrap;
}
.table-wrapper {
  width: 100%;
  overflow-x: auto;
  max-height: 70vh;
  overflow-y: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  min-width: 800px;
}
thead th {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
  background-color: #004080;
  color: white;
  position: sticky;
  top: 0;
  z-index: 2;
}
th, td {
  border: 1px solid #ddd;
  padding: 5px;
  text-align: center;
}
tbody tr:nth-child(even) { background-color: #f2f2f2; }
tbody tr:hover { background-color: #e0f0ff; }
.action-buttons button {
  width: 100%;
  margin: 2px 0;
  padding: 4px 8px;
  border-radius: 4px;
  border: none;
  color: white;
  font-size: 11px;
  cursor: pointer;
}
.logout-button {
  width: 150px;
  padding: 8px 0;
  font-size: 13px;
  border-radius: 5px;
  background-color: #2980b9;
  color: white;
  border: none;
  cursor: pointer;
  text-align: center;
}
.logout-button:hover { background-color: #3498db; }
#backBtn { background-color: #ddd; color: black; }
#backBtn:hover { background-color: #bbb; }
tr.inactive td {
  background-color: #f9d6d5;
  color: #aa0000;
  text-decoration: line-through;
}
.message {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #ffcc00;
  color: #000;
  padding: 20px;
  border: 2px solid #333;
  border-radius: 10px;
  font-size: 20px;
  text-transform: uppercase;
  z-index: 9999;
  text-align: center;
  width: 80%;
  max-width: 300px;
}
</style>
<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth-compat.js"></script>
</head>
<body>
<div class="container">
  <h2>SRAD - Sistema de Registro y Almacenamiento de Datos</h2>
  <div class="subtitulo">
    Docente: <span id="docenteNombre"></span> / Escuela: <span id="escuelaNombre"></span>
  </div>

  <div class="filters">
    <label>Curso:
      <select id="filterCurso"><option value="">Todos</option></select>
    </label>
    <label style="margin-left:20px;">
      <input type="checkbox" id="showInactive" checked> Mostrar usuarios inactivos
    </label>
  </div>

  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
    <button id="backBtn" class="logout-button">⬅ Volver al menú</button>
    <button class="logout-button" onclick="logout()">🚪 Cerrar sesión</button>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre y Apellido</th>
          <th>Usuario</th>
          <th>Escuela</th>
          <th>Curso</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="usersList">
        <tr><td colspan="6">Cargando usuarios...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="message" id="messageEl">ACCESO DENEGADO</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBVZaysx9d6u6P13DYINPtcinpf79Sgx4U",
  authDomain: "juego001-469b6.firebaseapp.com",
  databaseURL: "https://juego001-469b6-default-rtdb.firebaseio.com",
  projectId: "juego001-469b6",
  storageBucket: "juego001-469b6.appspot.com",
  messagingSenderId: "528847999661",
  appId: "1:528847999661:web:6085a104fe64262a042c24"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const ADMIN_UID = "SOqnLrm62vMx2F3cLvE6icvavRy1";
let allUsers = [];
let escuelaActual = "";
const container = document.querySelector(".container");
const messageEl = document.getElementById("messageEl");

// Mostrar datos del docente
document.getElementById("docenteNombre").textContent = (localStorage.getItem("nombreApellido") || "").toUpperCase();
document.getElementById("escuelaNombre").textContent = localStorage.getItem("tipoEscuela") || "";

// Mensajes secuenciales opcionales
let mensajePendiente = null;
let mensajeSecundario = null;
let audioPrimero = null;
let audioSegundo = null;

function setMensajesPendientes(msg1, msg2, aud1, aud2) {
  mensajePendiente = msg1; mensajeSecundario = msg2; audioPrimero = aud1; audioSegundo = aud2;
}
function mostrarMensajesSecuenciales(msg1, msg2, audio1, audio2) {
  messageEl.textContent = msg1; messageEl.style.display = "block";
  const a1 = new Audio(audio1); a1.play().catch(()=>{});
  a1.onended = () => {
    messageEl.textContent = msg2;
    const a2 = new Audio(audio2); a2.play().catch(()=>{});
    a2.onended = () => { window.location.href = "../index.html"; };
  };
}
window.addEventListener("click", () => {
  if(mensajePendiente && mensajeSecundario){
    mostrarMensajesSecuenciales(mensajePendiente, mensajeSecundario, audioPrimero, audioSegundo);
    mensajePendiente=null; mensajeSecundario=null;
  }
});

// Verificación de acceso
auth.onAuthStateChanged(async user => {
  const entrarA = localStorage.getItem("entrarA");
  const entrarB = localStorage.getItem("entrarB");
  if(!user || entrarA!==entrarB){ accesoDenegado(); return; }

  try{
    const rolSnap = await db.ref("usuarios/"+user.uid+"/rol").once("value");
    const rol = rolSnap.val();
    const activoSnap = await db.ref("usuarios/"+user.uid+"/activo").once("value");
    const activo = activoSnap.val()!==false;

    if(user.uid===ADMIN_UID || rol==="docente" || rol==="administrador"){
      localStorage.setItem("entrarB","NO");
      escuelaActual = localStorage.getItem("tipoEscuela") || "";
      container.style.display="flex";
      loadUsers();
    } else { accesoDenegado(); }
  }catch(err){
    console.error(err); accesoDenegado();
  }
});

function accesoDenegado(){
  container.style.display="none";
  setMensajesPendientes("ACCESO DENEGADO","SE TE REDIRIGIRÁ AL INICIO.","sound/fx/denegado.mp3","sound/fx/redireccionando.mp3");
}

// === Funciones de carga y renderizado de usuarios ===
async function getUsersFromFirebase() {
  try{
    const snapshot = await db.ref("usuarios").once("value");
    const data = snapshot.val()||{};
    return Object.entries(data).map(([key,value])=>({
      userKey:key,
      nombreApellido:value.nombreApellido||"",
      usuario:value.usuario||key,
      tipoEscuela:value.tipoEscuela||"",
      curso:value.curso||"",
      activo:value.activo!==false
    }));
  }catch(err){ console.error(err); return []; }
}

async function loadUsers(){
  allUsers = await getUsersFromFirebase();
  allUsers = allUsers.filter(u=>u.tipoEscuela===escuelaActual);
  populateFilters();
  applyFilters();
}

function renderUsers(users){
  const tbody = document.getElementById("usersList");
  tbody.innerHTML="";
  const showInactive = document.getElementById("showInactive").checked;
  const finalUsers = users.filter(u=>showInactive||u.activo);

  if(!finalUsers.length){
    tbody.innerHTML=`<tr><td colspan="6">No hay usuarios que coincidan.</td></tr>`;
    return;
  }

  finalUsers.forEach((user,index)=>{
    const row=document.createElement("tr");
    if(!user.activo) row.classList.add("inactive");

    const tdAcciones=document.createElement("td");
    tdAcciones.className="action-buttons";

    const infoBtn=document.createElement("button");
    infoBtn.textContent="Ver Informe";
    infoBtn.style.backgroundColor="#337ab7";
    infoBtn.onclick=()=>{ 
      localStorage.setItem("entrarA","SI"); 
      localStorage.setItem("entrarB","SI"); 
      window.location.href="reg.html?username="+encodeURIComponent(user.userKey); 
    };

    tdAcciones.appendChild(infoBtn);
    row.innerHTML=`<td>${index+1}</td><td>${user.nombreApellido}</td><td>${user.usuario}</td><td>${user.tipoEscuela}</td><td>${user.curso}</td>`;
    row.appendChild(tdAcciones);
    tbody.appendChild(row);
  });
}

// Filtros
function populateFilters(){
  const cursoSelect=document.getElementById("filterCurso");
  const cursos=[...new Set(allUsers.map(u=>u.curso).filter(c=>c))].sort();
  cursoSelect.innerHTML='<option value="">Todos</option>'+cursos.map(c=>`<option value="${c}">${c}</option>`).join('');
  cursoSelect.addEventListener("change", applyFilters);
}
function applyFilters(){
  const curso=document.getElementById("filterCurso").value;
  let filtered = allUsers;
  if(curso) filtered=filtered.filter(u=>u.curso===curso);
  renderUsers(filtered);
}
document.getElementById("showInactive").addEventListener("change",applyFilters);

// Navegación
async function logout() {
  localStorage.removeItem('uid');
  localStorage.removeItem('ActualUs');
  localStorage.removeItem('correo');
  localStorage.removeItem('password');
  localStorage.removeItem('adminEmail');
  localStorage.removeItem('adminPassword');
  localStorage.removeItem('entrarA');
  localStorage.removeItem('entrarB');
  const auth = getAuth();
  await signOut(auth);
  window.location.href = "index.html";
}

document.getElementById("backBtn").addEventListener("click",()=>{
  localStorage.setItem("entrarA","SI"); localStorage.setItem("entrarB","SI"); window.location.href="ActDocente.html";
});
</script>
</body>
</html>
