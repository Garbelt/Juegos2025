<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juegos de Usuarios</title>
<style>
body { 
  font-family: Arial; 
  display: flex; 
  justify-content: center; 
  align-items: flex-start; 
  min-height: 100vh; 
  margin: 0; 
}
.container { 
  border: 2px solid #ccc; 
  border-radius: 10px; 
  display: none; /* <-- ocultamos todo al cargar la página */
  padding: 20px; 
  max-width: 800px; 
  overflow-x: auto; 
  margin-top: 20px; 
  background-color: #fff; 
}
table { 
  width: 100%; 
  border-collapse: collapse; 
  margin: 20px auto 0 auto; 
  table-layout: fixed; 
}
thead th { 
  background-color: #004080; 
  color: white; 
  font-weight: bold; 
  font-size: 1.1em; 
  padding: 10px; 
  border-bottom: 3px solid #002050; 
  box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
  text-align: center; 
  position: sticky; 
  top: 0; 
  z-index: 2; 
}
tbody tr:nth-child(even) { 
  background-color: #f2f2f2; 
}
th, td { 
  padding: 8px; 
  border: 1px solid #ddd; 
  text-align: center; 
  word-wrap: break-word; 
}
.title-line1 { 
  font-size: 24px; 
  text-align: center; 
}
.title-line2 { 
  font-size: 14px; 
  text-align: center; 
  margin-top: 5px; 
  font-weight: normal; 
  color: #555; 
}
.button-container { 
  display: flex; 
  justify-content: center; 
  gap: 20px; 
  margin-top: 20px; 
}
.filter-container { 
  text-align: center; 
  margin-top: 10px; 
}
.filter-container select { 
  font-size: 16px; 
  padding: 4px 8px; 
}
.table-wrapper { 
  max-height: 400px; 
  overflow-y: auto; 
}

/* Estilos para mensaje de acceso denegado */
.message {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #ffcc00;
  color: #000;
  padding: 20px;
  border: 2px solid #333;
  border-radius: 10px;
  font-size: 20px;
  text-transform: uppercase;
  z-index: 9999;
  text-align: center;
  width: 80%;
  max-width: 300px;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth-compat.js"></script>
</head>
<body>
<div class="container">
  <h1 class="title-line1">JUEGOS DE: <span id="username-title"></span></h1>
  <div class="title-line2" id="user-details">Cargando información del usuario...</div>

  <div class="filter-container">
    <label for="game-filter">Filtrar por juego:</label>
    <select id="game-filter">
      <option value="todos">Todos</option>
    </select>
  </div>

  <div class="table-wrapper">
    <table id="games-table">
      <thead>
        <tr>
          <th style="width: 5%;">#</th>
          <th style="width: 15%;">Fecha</th>
          <th style="width: 60%;">Juego</th>
          <th style="width: 15%;">Puntaje</th>
        </tr>
      </thead>
      <tbody id="games-history"></tbody>
    </table>
  </div>

  <div class="button-container">
    <button id="generate-excel">Generar Excel</button>
    <button id="asrad">Volver a SRAD</button>
  </div>
</div>

<!-- Mensaje visual y sonoro -->
<div class="message" id="messageEl">ACCESO DENEGADO</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBVZaysx9d6u6P13DYINPtcinpf79Sgx4U",
  authDomain: "juego001-469b6.firebaseapp.com",
  databaseURL: "https://juego001-469b6-default-rtdb.firebaseio.com",
  projectId: "juego001-469b6",
  storageBucket: "juego001-469b6.appspot.com",
  messagingSenderId: "528847999661",
  appId: "1:528847999661:web:6085a104fe64262a042c24"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const urlParams = new URLSearchParams(window.location.search);
const userUID = urlParams.get('username') || ""; 
const usernameTitle = document.getElementById("username-title");
const userDetails = document.getElementById("user-details");
const tbody = document.getElementById("games-history");
const excelButton = document.getElementById("generate-excel");
const gameFilter = document.getElementById("game-filter");

let juegosGlobal = [];
const ADMIN_UID = "SOqnLrm62vMx2F3cLvE6icvavRy1";  // tu UID de administrador

// --- Sistema de mensajes visuales/sonoros ---
const messageEl = document.getElementById("messageEl");
let mensajePendiente = null;
let mensajeSecundario = null;
let audioPrimero = null;
let audioSegundo = null;

function setMensajesPendientes(msg1, msg2, aud1, aud2) {
  mensajePendiente = msg1;
  mensajeSecundario = msg2;
  audioPrimero = aud1;
  audioSegundo = aud2;
}

function mostrarMensajesSecuenciales(msg1, msg2, audio1, audio2) {
  messageEl.textContent = msg1;
  messageEl.style.display = "block";
  const a1 = new Audio(audio1);
  a1.play().catch(() => {});
  a1.onended = () => {
    messageEl.textContent = msg2;
    const a2 = new Audio(audio2);
    a2.play().catch(() => {});
    a2.onended = () => { window.location.href = "../index.html"; };
  };
}

window.addEventListener("click", () => {
  if (mensajePendiente && mensajeSecundario) {
    mostrarMensajesSecuenciales(mensajePendiente, mensajeSecundario, audioPrimero, audioSegundo);
    mensajePendiente = null;
    mensajeSecundario = null;
  }
});

// Mostrar mensaje de acceso denegado
function accesoDenegado() {
  document.querySelector(".container").style.display = "none";
  setMensajesPendientes(
    "ACCESO DENEGADO",
    "SE TE REDIRIGIRÁ AL INICIO",
    "sound/fx/denegado.mp3",
    "sound/fx/redireccionando.mp3"
  );
}

// --- Verificación de acceso ---
auth.onAuthStateChanged(async user => {
  const entrarA = localStorage.getItem("entrarA");
  const entrarB = localStorage.getItem("entrarB");

  if(!user || entrarA !== entrarB){
    accesoDenegado();
    return;
  }

  try {
    const rolSnap = await db.ref("usuarios/" + user.uid + "/rol").once("value");
    const rol = rolSnap.val();
    const activoSnap = await db.ref("usuarios/" + user.uid + "/activo").once("value");
    const activo = activoSnap.val() !== false;

    if ((rol === "docente" && activo) || rol === "administrador" || user.uid === ADMIN_UID) {
      localStorage.setItem("entrarB","NO"); // invalida ingreso doble
      document.querySelector(".container").style.display = "inline-block"; // <-- mostrar
      cargarTodo();  // Solo carga juegos si pasó verificación
    } else {
      accesoDenegado();
    }
  } catch (err) {
    console.error("Error al verificar acceso:", err);
    accesoDenegado();
  }
});

// --- Funciones de carga de usuario y juegos ---
async function cargarInfoUsuario() {
  try {
    const snapshot = await db.ref(`usuarios/${userUID}`).once('value');
    const userData = snapshot.val();
    if (userData) {
      const nombreUsuario = userData.usuario?.trim() || userUID;
      const nombreApellido = userData.nombreApellido?.trim() || nombreUsuario;
      const escuela = userData.tipoEscuela || "-";
      const curso = userData.curso || "-";

      usernameTitle.textContent = nombreUsuario; 
      userDetails.textContent = `${nombreApellido} — ${escuela} — ${curso}`;
      return nombreUsuario;
    } else {
      usernameTitle.textContent = userUID;
      userDetails.textContent = "Usuario no encontrado.";
      return userUID;
    }
  } catch {
    usernameTitle.textContent = userUID;
    userDetails.textContent = "Error al obtener información.";
    return userUID;
  }
}

async function leerJuegosFirebase(username) {
  try {
    const snapshot = await db.ref('/games').once('value');
    const data = snapshot.val();
    if (!data) return [];
    return Object.values(data)
                 .filter(game => (game.usuario || "").toLowerCase() === username.toLowerCase());
  } catch (e) {
    console.log("Error al leer juegos:", e);
    return [];
  }
}

function leerJuegosLocal(username) {
  try {
    const stored = JSON.parse(localStorage.getItem("gamesHistory")) || [];
    return stored.filter(game => (game.usuario || "").toLowerCase() === username.toLowerCase());
  } catch {
    return [];
  }
}

function llenarFiltro(juegos) {
  const juegosUnicos = [...new Set(juegos.map(g => g.title).filter(Boolean))];
  gameFilter.innerHTML = '<option value="todos">Todos</option>';
  juegosUnicos.forEach(j => {
    const opt = document.createElement("option");
    opt.value = j;
    opt.textContent = j;
    gameFilter.appendChild(opt);
  });
}

function mostrarJuegos(juegos, filtro="todos") {
  tbody.innerHTML = "";
  if (!juegos.length) {
    tbody.innerHTML = "<tr><td colspan='4'>No hay registros de juegos.</td></tr>";
    return;
  }

  juegos.sort((a,b) => {
    const [mA,dA,yA] = a.fecha.split("/").map(Number);
    const [mB,dB,yB] = b.fecha.split("/").map(Number);
    return new Date(yB+2000, mB-1, dB) - new Date(yA+2000, mA-1, dA);
  });

  const juegosFiltrados = (filtro === "todos") ? juegos : juegos.filter(j => j.title === filtro);

  juegosFiltrados.forEach((game,index)=>{
    const fechaFormateada = formatearFecha(game.fecha);
    const nombreJuego = game.title || '-';
    const puntaje = game.puntaje ?? '-';
    const row = document.createElement("tr");
    row.innerHTML = `<td>${index+1}</td><td>${fechaFormateada}</td><td>${nombreJuego}</td><td>${puntaje}</td>`;
    tbody.appendChild(row);
  });
}

function asignarEventoFiltro() {
  gameFilter.addEventListener("change", () => {
    mostrarJuegos(juegosGlobal, gameFilter.value);
  });
}

async function cargarTodo() {
  const usernameReal = await cargarInfoUsuario();
  let juegos = await leerJuegosFirebase(usernameReal);
  if (!juegos.length) juegos = leerJuegosLocal(usernameReal);
  juegosGlobal = juegos;
  llenarFiltro(juegosGlobal);
  asignarEventoFiltro();
  mostrarJuegos(juegosGlobal);
}

// Exportar Excel
excelButton.addEventListener("click", () => {
  const today = new Date();
  const dd = today.getDate().toString().padStart(2,'0');
  const mm = (today.getMonth()+1).toString().padStart(2,'0');
  const yy = today.getFullYear().toString().slice(-2);
  const fileName = `${dd}${mm}${yy}_${usernameTitle.textContent}.xls`;

  const tableHTML = document.getElementById('games-table').outerHTML;
  const excelHTML = `<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:x="urn:schemas-microsoft-com:office:excel"
      xmlns="http://www.w3.org/TR/REC-html40">
    <head><meta charset="UTF-8"></head>
    <body>
      <table>
        <tr><td colspan="4"><h1 style="font-size:24px; text-align:center;">INFORME DE ${usernameTitle.textContent}</h1></td></tr>
        <tr><td colspan="4" style="text-align:center;">${userDetails.textContent}</td></tr>
        <tr></tr>
        ${tableHTML}
      </table>
    </body>
  </html>`;
  const blob = new Blob([excelHTML], { type: 'application/vnd.ms-excel' });
  saveAs(blob, fileName);
});

document.getElementById("asrad").addEventListener("click", () => {
  const codigoSeguridad = Math.floor(1000 + Math.random() * 9000);
  localStorage.setItem("entrarA", codigoSeguridad);
  localStorage.setItem("entrarB", codigoSeguridad);
  window.location.href = "./srad.html";
});

function formatearFecha(fechaInput) {
  if (!fechaInput) return '-';
  const partes = fechaInput.split("/");
  if (partes.length === 3) {
    const dia = partes[0].padStart(2, "0");
    const mes = partes[1].padStart(2, "0");
    const anio = partes[2].slice(-2);
    return `${dia}/${mes}/${anio}`;
  }
  return fechaInput;
}
</script>
</body>
</html>
